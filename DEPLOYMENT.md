# ğŸš€ Deployment Guide - HÆ°á»›ng dáº«n Ä‘Æ°a project lÃªn web

## ğŸ“‹ Má»¥c lá»¥c
- [1. Railway.app (Khuyáº¿n nghá»‹ - Miá»…n phÃ­)](#1-railwayapp)
- [2. Render.com (Alternative)](#2-rendercom)
- [3. Google Cloud Run (Professional)](#3-google-cloud-run)
- [4. AWS EC2 (Full control)](#4-aws-ec2)
- [5. VPS (DigitalOcean/Vultr)](#5-vps)

---

## 1. Railway.app (Khuyáº¿n nghá»‹ - Miá»…n phÃ­)

### âœ… Æ¯u Ä‘iá»ƒm:
- âœ… Miá»…n phÃ­ $5/thÃ¡ng credit
- âœ… Tá»± Ä‘á»™ng deploy tá»« GitHub
- âœ… Há»— trá»£ Docker Compose
- âœ… Free PostgreSQL database
- âœ… Tá»± Ä‘á»™ng HTTPS
- âœ… Setup trong 5 phÃºt

### ğŸ“ BÆ°á»›c 1: Chuáº©n bá»‹ code

```bash
# 1. Commit táº¥t cáº£ thay Ä‘á»•i
git add .
git commit -m "Prepare for deployment"
git push origin main

# 2. Äáº£m báº£o cÃ³ file .env.example
# (Ä‘Ã£ cÃ³ sáºµn trong project)
```

### ğŸ“ BÆ°á»›c 2: Deploy lÃªn Railway

1. **ÄÄƒng kÃ½ tÃ i khoáº£n:**
   - Truy cáº­p: https://railway.app/
   - Sign up báº±ng GitHub account

2. **Táº¡o project má»›i:**
   - Click "New Project"
   - Chá»n "Deploy from GitHub repo"
   - Chá»n repository: `Ber173/NT219.Q11.ATTN`

3. **Add PostgreSQL database:**
   - Click "New" â†’ "Database" â†’ "Add PostgreSQL"
   - Railway sáº½ tá»± Ä‘á»™ng táº¡o database

4. **Cáº¥u hÃ¬nh environment variables:**
   Click vÃ o service â†’ "Variables" â†’ Add táº¥t cáº£ biáº¿n tá»« `.env`:
   
   ```bash
   # Database (Railway tá»± Ä‘á»™ng generate)
   database_hostname=postgres.railway.internal
   database_port=5432
   database_username=postgres
   database_password=<auto-generated>
   database_name=railway
   
   # Security Keys (PHáº¢I Táº O Má»šI)
   USER_AES_KEY=<generate má»›i - xem bÃªn dÆ°á»›i>
   Key_AES=<generate má»›i>
   secret_key=<generate má»›i>
   
   # Stripe (náº¿u cÃ³)
   STRIPE_API_KEY=sk_test_...
   STRIPE_PUBLIC_KEY=pk_test_...
   
   # JWT
   algorithm=HS256
   access_token_expire_minutes=60
   ```

5. **Generate keys cho production:**
   ```bash
   # Generate USER_AES_KEY (32 bytes base64)
   python -c "import base64, secrets; print(base64.b64encode(secrets.token_bytes(32)).decode())"
   
   # Generate secret_key
   python -c "import secrets; print(secrets.token_urlsafe(32))"
   ```

6. **Deploy:**
   - Railway sáº½ tá»± Ä‘á»™ng build vÃ  deploy
   - Äá»£i ~3-5 phÃºt
   - Click "Generate Domain" Ä‘á»ƒ cÃ³ public URL

### ğŸŒ BÆ°á»›c 3: Truy cáº­p website

```
https://your-project-name.up.railway.app
```

### âš™ï¸ BÆ°á»›c 4: Kiá»ƒm tra logs

```bash
# Trong Railway dashboard
Click vÃ o service â†’ "Deployments" â†’ "View Logs"
```

---

## 2. Render.com (Alternative - CÅ©ng miá»…n phÃ­)

### ğŸ“ Setup steps:

1. **ÄÄƒng kÃ½:** https://render.com/
2. **New Web Service** â†’ Connect GitHub repo
3. **Build command:**
   ```bash
   docker build -t backend ./backend
   ```
4. **Start command:**
   ```bash
   docker run -p 8000:8000 backend
   ```
5. **Add PostgreSQL database** (Free tier)
6. **Set environment variables** (giá»‘ng Railway)

### ğŸŒ URL:
```
https://your-app-name.onrender.com
```

---

## 3. Google Cloud Run (Professional)

### âœ… Æ¯u Ä‘iá»ƒm:
- âœ… Chá»‰ tráº£ tiá»n khi cÃ³ traffic
- âœ… Auto-scaling
- âœ… Free $300 credit (3 thÃ¡ng Ä‘áº§u)
- âœ… HTTPS miá»…n phÃ­

### ğŸ“ Setup:

```bash
# 1. Install Google Cloud CLI
# https://cloud.google.com/sdk/docs/install

# 2. Login
gcloud auth login
gcloud config set project YOUR_PROJECT_ID

# 3. Build vÃ  push Docker image
cd backend
gcloud builds submit --tag gcr.io/YOUR_PROJECT_ID/payment-gateway

# 4. Deploy
gcloud run deploy payment-gateway \
  --image gcr.io/YOUR_PROJECT_ID/payment-gateway \
  --platform managed \
  --region asia-southeast1 \
  --allow-unauthenticated \
  --set-env-vars USER_AES_KEY=xxx,database_hostname=xxx

# 5. Add Cloud SQL (PostgreSQL)
gcloud sql instances create payment-db \
  --database-version=POSTGRES_15 \
  --tier=db-f1-micro \
  --region=asia-southeast1
```

### ğŸŒ URL:
```
https://payment-gateway-xxx-as.a.run.app
```

---

## 4. AWS EC2 (Full Control)

### ğŸ“ Setup:

```bash
# 1. Launch EC2 instance (t2.micro free tier)
# Ubuntu 22.04 LTS

# 2. SSH vÃ o server
ssh -i your-key.pem ubuntu@ec2-xxx.compute.amazonaws.com

# 3. Install Docker
sudo apt update
sudo apt install docker.io docker-compose -y
sudo usermod -aG docker ubuntu

# 4. Clone code
git clone https://github.com/Ber173/NT219.Q11.ATTN.git
cd NT219.Q11.ATTN/NT219.Q11.ATTN-4

# 5. Setup .env
cp .env.example .env
nano .env  # Fill in values

# 6. Run Docker Compose
docker compose up -d

# 7. Setup Nginx reverse proxy
sudo apt install nginx -y
sudo nano /etc/nginx/sites-available/payment-gateway
```

**Nginx config:**
```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

```bash
# 8. Enable site
sudo ln -s /etc/nginx/sites-available/payment-gateway /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx

# 9. Setup SSL (Let's Encrypt)
sudo apt install certbot python3-certbot-nginx -y
sudo certbot --nginx -d your-domain.com
```

### ğŸŒ URL:
```
https://your-domain.com
```

---

## 5. VPS (DigitalOcean/Vultr)

### ğŸ’° Chi phÃ­: $4-6/thÃ¡ng

### ğŸ“ Setup (giá»‘ng AWS EC2):

1. **Táº¡o Droplet/Instance:**
   - OS: Ubuntu 22.04
   - Size: Basic $4/mo (1GB RAM)
   - Region: Singapore

2. **Follow AWS EC2 steps above**

3. **Point domain:**
   ```bash
   # Add A record in DNS:
   A    @    your-server-ip
   ```

---

## ğŸ”’ Security Checklist (QUAN TRá»ŒNG!)

### âœ… TrÆ°á»›c khi deploy:

- [ ] **Äá»•i táº¥t cáº£ secret keys** (khÃ´ng dÃ¹ng key dev)
- [ ] **Enable HTTPS** (báº¯t buá»™c cho payment)
- [ ] **Set strong database password**
- [ ] **Restrict database access** (chá»‰ backend)
- [ ] **Enable firewall** (chá»‰ má»Ÿ port 80, 443, 22)
- [ ] **Setup backup database** (daily)
- [ ] **Add rate limiting** (Ä‘Ã£ cÃ³ trong code)
- [ ] **Enable logging** (ELK/CloudWatch)
- [ ] **Test payment flow** vá»›i test card
- [ ] **Verify CORS settings**

### ğŸ” Production `.env` template:

```bash
# Database (Cloud provider)
database_hostname=xxx.postgres.railway.app
database_port=5432
database_username=postgres
database_password=<strong-random-password>
database_name=payment_gateway

# Security (PHáº¢I GENERATE Má»šI!)
USER_AES_KEY=<32-byte-base64>
Key_AES=<32-byte-base64>
secret_key=<random-string-64-chars>

# Stripe PRODUCTION keys (náº¿u ready)
STRIPE_API_KEY=sk_live_...  # Sá»¬ Dá»¤NG sk_test_ cho testing
STRIPE_PUBLIC_KEY=pk_live_...

# JWT
algorithm=HS256
access_token_expire_minutes=60

# Optional: HSM
SOFTHSM_LIB=/usr/lib/softhsm/libsofthsm2.so
```

---

## ğŸ§ª Testing sau khi deploy

### 1. Kiá»ƒm tra health:
```bash
curl https://your-domain.com/docs
# Pháº£i tráº£ vá» Swagger UI
```

### 2. Test registration:
```bash
curl -X POST https://your-domain.com/user_service/auth/register \
  -F "name=Test User" \
  -F "email=test@example.com" \
  -F "phone=0901234567" \
  -F "username=testuser" \
  -F "password=Test@123"
```

### 3. Test login:
```bash
curl -X POST https://your-domain.com/user_service/auth/login \
  -F "username=testuser" \
  -F "password=Test@123"
```

### 4. Test payment flow:
- DÃ¹ng Stripe test card: `4242 4242 4242 4242`
- CVV: `123`
- Expiry: báº¥t ká»³ tÆ°Æ¡ng lai

---

## ğŸ“Š So sÃ¡nh cÃ¡c phÆ°Æ¡ng Ã¡n

| Platform | Chi phÃ­ | Setup | Auto-deploy | Database | SSL | Khuyáº¿n nghá»‹ |
|----------|---------|-------|-------------|----------|-----|-------------|
| **Railway** | Free ($5 credit) | â­â­â­â­â­ | âœ… | âœ… Free | âœ… Auto | **Best cho demo** |
| **Render** | Free | â­â­â­â­ | âœ… | âœ… Free | âœ… Auto | Good alternative |
| **Google Cloud Run** | Pay-as-go | â­â­â­ | âœ… | Extra setup | âœ… Auto | Best cho scale |
| **AWS EC2** | ~$10/mo | â­â­ | âŒ | Extra setup | Manual | Full control |
| **VPS** | $4-6/mo | â­â­ | âŒ | Self-host | Manual | Cheapest long-term |

---

## ğŸ¯ Khuyáº¿n nghá»‹ cho project cá»§a báº¡n

### **Cho Demo/Presentation:**
â†’ **Railway.app** (5 phÃºt setup, miá»…n phÃ­, Ä‘á»§ tÃ­nh nÄƒng)

### **Cho Production tháº­t:**
â†’ **Google Cloud Run** + **Cloud SQL** (scalable, reliable)

### **Cho há»c táº­p/thá»±c hÃ nh:**
â†’ **VPS (DigitalOcean)** (full control, há»c Ä‘Æ°á»£c nhiá»u)

---

## ğŸ†˜ Troubleshooting

### âŒ "Database connection refused"
```bash
# Kiá»ƒm tra database_hostname
# Railway: dÃ¹ng private URL (postgres.railway.internal)
# Render: dÃ¹ng internal URL
```

### âŒ "CORS error"
```bash
# Update CORS middleware trong gateway/middleware/cors.py
# Add domain cá»§a báº¡n vÃ o allowed_origins
```

### âŒ "Port already in use"
```bash
# Railway/Render tá»± Ä‘á»™ng bind port tá»« $PORT env variable
# Update Dockerfile CMD:
CMD ["uvicorn", "backend.main:app", "--host", "0.0.0.0", "--port", "${PORT:-8000}"]
```

---

## ğŸ“ Support

Náº¿u gáº·p váº¥n Ä‘á»:
1. Check logs trong platform dashboard
2. Test locally vá»›i Docker Compose trÆ°á»›c
3. Verify táº¥t cáº£ environment variables
4. Check database connection string

---

## ğŸ“ Next Steps

Sau khi deploy thÃ nh cÃ´ng:
1. âœ… Share URL cho báº¡n bÃ¨ test
2. âœ… Monitor logs vÃ  performance
3. âœ… Setup backup database
4. âœ… Add monitoring (Sentry, New Relic)
5. âœ… Custom domain (náº¿u cÃ³)
6. âœ… Setup CI/CD pipeline

